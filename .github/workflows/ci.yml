name: CI Pipeline

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ============================================
  # Code Quality
  # ============================================
  lint:
    name: üîç Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          
      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}
        
      - name: Install dependencies
        run: uv sync --dev
        
      - name: Run ruff linter
        run: uv run ruff check .
        
      - name: Run ruff formatter check
        run: uv run ruff format --check .

  typecheck:
    name: üî¨ Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        
      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}
        
      - name: Install dependencies
        run: uv sync --dev
        
      - name: Run mypy
        run: uv run mypy src/

  security:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        
      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}
        
      - name: Install dependencies
        run: uv sync --dev
        
      - name: Run bandit
        run: uv run bandit -r src/ -c pyproject.toml
        
      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

  # ============================================
  # Tests
  # ============================================
  test-unit:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        
      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}
        
      - name: Install dependencies
        run: uv sync --dev
        
      - name: Run unit tests
        run: |
          uv run pytest tests/unit \
            -v \
            --cov=src \
            --cov-report=xml \
            --cov-report=term-missing \
            -m "unit"
            
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unit
          
  test-integration:
    name: üîó Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test-unit]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        
      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}
        
      - name: Install dependencies
        run: uv sync --dev
        
      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          uv run pytest tests/integration \
            -v \
            --cov=src \
            --cov-report=xml \
            -m "integration"
            
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: integration

  # ============================================
  # Build Validation
  # ============================================
  docker-build:
    name: üê≥ Docker Build
    runs-on: ubuntu-latest
    needs: [lint, test-unit]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build images
        run: |
          docker compose build --parallel
          
      - name: Test container startup
        run: |
          docker compose up -d
          sleep 30
          docker compose ps
          docker compose down

  # ============================================
  # Summary
  # ============================================
  ci-success:
    name: ‚úÖ CI Success
    runs-on: ubuntu-latest
    needs: [lint, typecheck, security, test-unit, test-integration, docker-build]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.typecheck.result }}" == "failure" ]] || \
             [[ "${{ needs.security.result }}" == "failure" ]] || \
             [[ "${{ needs.test-unit.result }}" == "failure" ]] || \
             [[ "${{ needs.test-integration.result }}" == "failure" ]] || \
             [[ "${{ needs.docker-build.result }}" == "failure" ]]; then
            echo "‚ùå One or more jobs failed"
            exit 1
          fi
          echo "‚úÖ All jobs passed"