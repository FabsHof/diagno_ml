# =============================================================================
# DiagnoML Docker Compose Configuration
# =============================================================================
# Development environment for the DiagnoML clinical diagnosis prediction PoC

services:
  # ===========================================================================
  # Core Services
  # ===========================================================================

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: diagnoml-api
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-mlflow}
      - POSTGRES_USER=${POSTGRES_USER:-mlflow}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-mlflow}
    volumes:
      - ./src:/app/src
      - ./flows:/app/flows
    depends_on:
      postgres:
        condition: service_healthy
      mlflow:
        condition: service_started
    networks:
      - diagnoml-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # ML Infrastructure
  # ===========================================================================

  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.17.0
    container_name: diagnoml-mlflow
    ports:
      - "5000:5000"
    environment:
      - MLFLOW_BACKEND_STORE_URI=postgresql://${POSTGRES_USER:-mlflow}:${POSTGRES_PASSWORD:-mlflow}@postgres:5432/${POSTGRES_DB:-mlflow}
      - MLFLOW_DEFAULT_ARTIFACT_ROOT=/mlflow/artifacts
    volumes:
      - mlflow-artifacts:/mlflow/artifacts
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - diagnoml-network
    command: >
      mlflow server
      --host 0.0.0.0
      --port 5000
      --backend-store-uri postgresql://${POSTGRES_USER:-mlflow}:${POSTGRES_PASSWORD:-mlflow}@postgres:5432/${POSTGRES_DB:-mlflow}
      --default-artifact-root /mlflow/artifacts

  # ===========================================================================
  # Databases
  # ===========================================================================

  postgres:
    image: postgres:15-alpine
    container_name: diagnoml-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-mlflow}
      - POSTGRES_USER=${POSTGRES_USER:-mlflow}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-mlflow}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - diagnoml-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mlflow} -d ${POSTGRES_DB:-mlflow}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # Monitoring
  # ===========================================================================

  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: diagnoml-prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./configs/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - diagnoml-network
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-lifecycle"

  grafana:
    image: grafana/grafana:10.2.0
    container_name: diagnoml-grafana
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./configs/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./configs/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - diagnoml-network

# =============================================================================
# Networks
# =============================================================================

networks:
  diagnoml-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================

volumes:
  postgres-data:
  mlflow-artifacts:
  prometheus-data:
  grafana-data:
